6. ê¸°ëŠ¥ë³„ í†µí•© êµ¬í˜„ ìƒì„¸ ê°€ì´ë“œ (Frontend & Backend)
6.1. ì´ˆê¸° ì„¤ì • ë° ê³µí†µ ëª¨ë“ˆ
[Frontend]
íŒŒì¼ êµ¬ì¡°

/ (Replit í”„ë¡œì íŠ¸ ë£¨íŠ¸)
index.html
app.js
styles.css
assets/ (ì‚¬ìš´ë“œ íŒŒì¼, ì´ë¯¸ì§€ ë“±)
ì „ì—­ ìƒíƒœ ê°ì²´ (app.js)

ì½”ë“œì˜ ì¼ê´€ì„±ê³¼ ìœ ì§€ë³´ìˆ˜ë¥¼ ìœ„í•´ ëª¨ë“  ìƒíƒœë¥¼ í•˜ë‚˜ì˜ ê°ì²´ì—ì„œ ê´€ë¦¬í•©ë‹ˆë‹¤.
JavaScript

// app.js ìƒë‹¨
const appState = {
    userId: null,
    totalPoints: 0,
    stageState: 0,
    surveyStep: 0,
    cardIndex: 0,
    videoProgress: 0,
    spendAmount: 0,
};
ê³µí†µ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ (app.js)

ë°˜ë³µì ìœ¼ë¡œ ì‚¬ìš©ë  API í˜¸ì¶œ, ì‚¬ìš´ë“œ/ì• ë‹ˆë©”ì´ì…˜ í•¨ìˆ˜ë¥¼ ë¯¸ë¦¬ ì •ì˜í•©ë‹ˆë‹¤.
JavaScript

// API í˜¸ì¶œ ê¸°ë³¸ í•¨ìˆ˜
async function apiPost(path, data) {
  const res = await fetch(path, {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(data)
  });
  if (!res.ok) {
    const errorData = await res.json();
    throw new Error(errorData.detail || 'API ìš”ì²­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
  return res.json();
}

// í¬ì¸íŠ¸ íšë“ ì• ë‹ˆë©”ì´ì…˜ (ì˜ˆì‹œ)
function showPointAnimation(points) {
  // í™”ë©´ì— "+<points>í¬ì¸íŠ¸" í…ìŠ¤íŠ¸ê°€ ë‚˜íƒ€ë‚¬ë‹¤ê°€ ì‚¬ë¼ì§€ëŠ” DOM ì¡°ì‘ ì½”ë“œ
  console.log(`ì• ë‹ˆë©”ì´ì…˜: +${points} í¬ì¸íŠ¸!`);
}

// ì‚¬ìš´ë“œ ì¬ìƒ (ì˜ˆì‹œ)
function playSound(type) {
  // new Audio('assets/<type>.mp3').play();
  console.log(`ì‚¬ìš´ë“œ ì¬ìƒ: ${type}`);
}
[Backend]
DB ì´ˆê¸°í™” ìŠ¤í¬ë¦½íŠ¸ (setup_db.py)

í”„ë¡œì íŠ¸ ì‹œì‘ ì „, Replit Shellì—ì„œ python setup_db.pyë¥¼ ì‹¤í–‰í•˜ì—¬ ì´ˆê¸° ë°ì´í„°ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
Python

# setup_db.py
from replit import db

# ì°¸ì—¬ í—ˆìš©ëœ ì‚¬ìš©ì ëª©ë¡
db["allowed_users"] = ("peter-a4t7", "joy-b5g8", "chris-c9h1")

# ì‚¬íšŒì  ì¦ê±°ìš© ì „ì—­ í†µê³„
db["global_stats"] = {
    "participants": 0,
    "total_points_awarded": 0,
    "video_viewers": 0,
    "card_finishers": 0
}

# ê¸°ì¡´ ì‚¬ìš©ì ë°ì´í„° ì‚­ì œ (í…ŒìŠ¤íŠ¸ ì‹œ ìœ ìš©)
for key in db.keys():
    if key.startswith("user:"):
        del db[key]

print("âœ… Replit DBê°€ ì„±ê³µì ìœ¼ë¡œ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.")
FastAPI ì•± ì´ˆê¸°í™” (main.py)

ê¸°ë³¸ì ì¸ FastAPI ì•± êµ¬ì¡°ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
Python

# main.py
from fastapi import FastAPI, HTTPException
from pydantic import BaseModel
from replit import db
import random

app = FastAPI()

# --- Pydantic ëª¨ë¸ ì •ì˜ ---
class IdentifyRequest(BaseModel):
    nickname: str

# ... (ë‹¤ë¥¸ ìš”ì²­ ëª¨ë¸ë“¤)

# --- API ì—”ë“œí¬ì¸íŠ¸ êµ¬í˜„ ---
# ... (ì•„ë˜ì—ì„œ ê° ì—”ë“œí¬ì¸íŠ¸ êµ¬í˜„)
6.2. 1ë‹¨ê³„: ë‹‰ë„¤ì„ ì¸ì¦
[Frontend] (app.js)
ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ: 'ì‹œì‘í•˜ê¸°' ë²„íŠ¼ í´ë¦­ ì‹œ /api/identifyë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.
UI ì—…ë°ì´íŠ¸: ì‘ë‹µ ê²°ê³¼ì— ë”°ë¼ í™˜ì˜ íŒì—… ë˜ëŠ” ì˜¤ë¥˜ ë©”ì‹œì§€ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.
JavaScript

const btnStart = document.getElementById('btn-start');
const nicknameInput = document.getElementById('nickname-input');
const sectionNickname = document.getElementById('section-nickname');
const sectionSurvey = document.getElementById('section-survey');

btnStart.addEventListener('click', async () => {
    const nickname = nicknameInput.value.trim();
    if (!nickname) {
        alert('ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
        return;
    }

    try {
        const res = await apiPost('/api/identify', { nickname });

        // ìƒíƒœ ì—…ë°ì´íŠ¸
        appState.userId = res.userId;
        appState.totalPoints = res.points;
        appState.stageState = res.stage_state;

        // UI í”¼ë“œë°±
        alert(`í™˜ì˜í•©ë‹ˆë‹¤, ${res.userId}ë‹˜! ğŸ‰\n+${res.points}í¬ì¸íŠ¸ê°€ ì…ê¸ˆëì–´ìš”.`);
        playSound('success');
        showPointAnimation(res.points);

        // ë‹¤ìŒ ë‹¨ê³„ë¡œ ì „í™˜
        sectionNickname.classList.add('hidden');
        sectionSurvey.classList.remove('hidden');
        // loadSurveyQuestion(); // ë‹¤ìŒ ë‹¨ê³„ì—ì„œ êµ¬í˜„

    } catch (error) {
        alert(error.message); // "ì°¸ì—¬ ìê²©ì´ ì—†ëŠ” ì‚¬ìš©ìì…ë‹ˆë‹¤." ë“±
        playSound('error');
    }
});
[Backend] (main.py)
ì—”ë“œí¬ì¸íŠ¸: /api/identifyë¥¼ êµ¬í˜„í•©ë‹ˆë‹¤.
ë¡œì§: ìê²© ê²€ì¦ í›„, ì‹ ê·œ ì‚¬ìš©ìì¼ ê²½ìš° DBì— ìƒíƒœë¥¼ ìƒì„±í•˜ê³  global_statsë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
Python

@app.post("/api/identify")
async def identify(req: IdentifyRequest):
    nickname = req.nickname

    # 1. ìê²© ê²€ì¦
    if nickname not in db.get("allowed_users", ()):
        raise HTTPException(status_code=403, detail="ì°¸ì—¬ ìê²©ì´ ì—†ëŠ” ì‚¬ìš©ìì…ë‹ˆë‹¤.")

    # 2. ê¸°ì¡´ ì°¸ì—¬ìì¸ì§€ í™•ì¸
    if f"user:{nickname}:valid" in db:
        # (ê¸°íšì— ë”°ë¼) ê¸°ì¡´ ìœ ì €ëŠ” ìƒíƒœë¥¼ ë¶ˆëŸ¬ì™€ ë°”ë¡œ í•´ë‹¹ ë‹¨ê³„ë¡œ ë³´ë‚´ê±°ë‚˜,
        # ì—¬ê¸°ì„œëŠ” ê°„ë‹¨íˆ ì—ëŸ¬ ì²˜ë¦¬
        raise HTTPException(status_code=400, detail="ì´ë¯¸ ì°¸ì—¬í•œ ì‚¬ìš©ìì…ë‹ˆë‹¤.")

    # 3. ì‹ ê·œ ì‚¬ìš©ì ìƒíƒœ ì´ˆê¸°í™”
    db[f"user:{nickname}:valid"] = "1"
    db[f"user:{nickname}:points"] = 50
    db[f"user:{nickname}:stage_state"] = 1 # ì„¤ë¬¸ ë‹¨ê³„
    db[f"user:{nickname}:survey_step"] = 0
    db[f"user:{nickname}:card_index"] = 0
    db[f"user:{nickname}:video_progress"] = 0
    db[f"user:{nickname}:spend_amount"] = 0
    db[f"user:{nickname}:spend_tier"] = 0

    # 4. ì „ì—­ í†µê³„ ì—…ë°ì´íŠ¸
    stats = db.get("global_stats", {})
    stats["participants"] = stats.get("participants", 0) + 1
    db["global_stats"] = stats

    return {
      "valid": True,
      "userId": nickname,
      "is_new": True,
      "points": 50,
      "stage_state": 1
    }
ì—¬ê¸°ê¹Œì§€ 1ë‹¨ê³„(ë‹‰ë„¤ì„ ì¸ì¦)ì˜ í†µí•© êµ¬í˜„ ê°€ì´ë“œì…ë‹ˆë‹¤. ì½”ë“œ ìˆ˜ì¤€ì—ì„œ í”„ë¡ íŠ¸ì—”ë“œì™€ ë°±ì—”ë“œê°€ ì–´ë–»ê²Œ ëª…í™•í•˜ê²Œ ìƒí˜¸ì‘ìš©í•˜ëŠ”ì§€ í™•ì¸í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì´ ê°€ì´ë“œì— ë”°ë¼ ì‹¤ì œ Replit í”„ë¡œì íŠ¸ì— ì½”ë“œë¥¼ ì‘ì„±í•˜ê¸° ì‹œì‘í•˜ê² ìŠµë‹ˆë‹¤. íŒŒíŠ¸ë„ˆë‹˜ê»˜ì„œëŠ” ì´ ë‚´ìš©ì„ ê²€í† í•´ ì£¼ì‹œê³ , ì˜ê²¬ì´ ìˆìœ¼ì‹œë©´ ì–¸ì œë“  ì•Œë ¤ì£¼ì„¸ìš”.

ê´œì°®ìœ¼ì‹œë‹¤ë©´, ì´ì–´ì„œ 3ë‹¨ê³„(ì¹´ë“œë‰´ìŠ¤)ë¶€í„° ë‚˜ë¨¸ì§€ ë‹¨ê³„ë“¤ì˜ êµ¬í˜„ ê°€ì´ë“œë¥¼ ì‘ì„±í•˜ê² ìŠµë‹ˆë‹¤.


ì†ŒìŠ¤




ë‚œ ì§€ê¸ˆ ë¬¸ì„œí™” ì‘ì—…ì´ì—ˆê³ 

ëˆ„ê°€ ë§˜ëŒ€ë¡œ í”„ë¡œì íŠ¸íŒŒì¼ ë“¤ì–´ê°€ë˜...

6/7 í†µí•© ê¸°ì¤€ì„œ ë¶€í„° ì¤˜ì•¼í•˜ì§€


í…”
í…”ë ˆì±—ë´‡
ì‚¬ìš©ìì„¤ì • Gem

ìƒê°í•˜ëŠ” ê³¼ì • í‘œì‹œ
íŒŒíŠ¸ë„ˆë‹˜, ì •ë§ ì£„ì†¡í•©ë‹ˆë‹¤. ì œê°€ ë„ˆë¬´ ì•ì„œë‚˜ê°”ìŠµë‹ˆë‹¤.

ë¶„ëª… ë¬¸ì„œí™” ì‘ì—…ì„ ì™„ë£Œí•˜ëŠ” ê²ƒì´ í˜„ì¬ ë‹¨ê³„ì˜ ëª©í‘œì˜€ëŠ”ë°, ì œê°€ ì„±ê¸‰í•˜ê²Œ ì‹¤ì œ ì½”ë“œ ì‘ì„±ì„ ì–¸ê¸‰í•˜ë©° íŒŒíŠ¸ë„ˆë‹˜ì„ ë¶ˆí¸í•˜ê²Œ ë§Œë“¤ì—ˆìŠµë‹ˆë‹¤. ì´ê²ƒì€ ëª…ë°±íˆ ì €ì˜ ì˜ëª»ì´ë©°, íŒŒíŠ¸ë„ˆë‹˜ì˜ ì‘ì—… íë¦„ê³¼ í†µì œê¶Œì„ ì¡´ì¤‘í•˜ì§€ ëª»í•œ í–‰ë™ì´ì—ˆìŠµë‹ˆë‹¤.

íŠ¹íˆ 'ëª¨ë“  ë‹¨ê³„ì—ì„œ ì‚¬ìš©ìë‹˜ì˜ í†µì œê¶Œì„ ë³´ì¥'í•˜ê³ , 'ì–´ë–¤ ì‘ì—…ì´ë“  ì‚¬ì „ì— ëª…í™•íˆ ê³ ì§€í•˜ê³  ë™ì˜ë¥¼ êµ¬í•˜ê² ë‹¤'ê³  ì•½ì†ë“œë ¸ëŠ”ë°, ê·¸ ì›ì¹™ì„ ì–´ê²¼ìŠµë‹ˆë‹¤. ì‹ ë¢°ë¥¼ ê¹¨ëœ¨ë¦´ ìˆ˜ ìˆëŠ” í–‰ë™ì´ì—ˆìŒì„ ê¹Šì´ ë°˜ì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤.

ë‹¤ì‹œ ë¬¸ì„œí™” ì‘ì—…ì—ë§Œ ì§‘ì¤‘í•˜ê² ìŠµë‹ˆë‹¤. í”„ë¡œì íŠ¸ íŒŒì¼ì´ë‚˜ ì‹¤ì œ ì½”ë”©ì— ëŒ€í•œ ì–¸ê¸‰ì€ ëª¨ë‘ ìŠì–´ì£¼ì‹­ì‹œì˜¤.

ì•½ì†ë“œë¦° ëŒ€ë¡œ, ë¨¼ì € '6. ê¸°ëŠ¥ë³„ í†µí•© êµ¬í˜„ ìƒì„¸ ê°€ì´ë“œ' ë¬¸ì„œë¶€í„° ì™„ë²½í•˜ê²Œ ë§ˆë¬´ë¦¬í•˜ì—¬ ì „ë‹¬ë“œë¦¬ê² ìŠµë‹ˆë‹¤. ì•„ë˜ì— ê°€ì´ë“œì˜ ë‚˜ë¨¸ì§€ ë¶€ë¶„ì„ ì´ì–´ì„œ ì‘ì„±í–ˆìŠµë‹ˆë‹¤. ê²€í†  ë¶€íƒë“œë¦½ë‹ˆë‹¤.

6.4. 3ë‹¨ê³„: ì¹´ë“œë‰´ìŠ¤
[Frontend] (app.js)
í•µì‹¬ ë¡œì§: scroll ì´ë²¤íŠ¸ëŠ” ë§¤ìš° ë¹ˆë²ˆí•˜ê²Œ ë°œìƒí•˜ë¯€ë¡œ, **ë””ë°”ìš´ìŠ¤(Debounce)**ë¥¼ ì ìš©í•˜ì—¬ ìŠ¤í¬ë¡¤ì´ ë©ˆì¶˜ í›„ í•œ ë²ˆë§Œ APIë¥¼ í˜¸ì¶œí•˜ë„ë¡ ì„±ëŠ¥ì„ ìµœì í™”í•©ë‹ˆë‹¤.
UI ì—…ë°ì´íŠ¸: ê° ìŠ¬ë¼ì´ë“œ í™•ì¸ ì‹œ í¬ì¸íŠ¸ ì• ë‹ˆë©”ì´ì…˜ì„ ë³´ì—¬ì£¼ê³ , ë§ˆì§€ë§‰ ìŠ¬ë¼ì´ë“œì—ì„œëŠ” ì˜ìƒ ì„¹ì…˜ì„ ë…¸ì¶œí•©ë‹ˆë‹¤.
JavaScript

const cardSlider = document.getElementById('card-slider');
const sectionCard = document.getElementById('section-cardnews');
const sectionVideo = document.getElementById('section-video');
let scrollTimer;

// ë””ë°”ìš´ìŠ¤ ì ìš©ëœ ìŠ¤í¬ë¡¤ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
cardSlider.addEventListener('scroll', () => {
    clearTimeout(scrollTimer);
    scrollTimer = setTimeout(handleCardView, 300); // 300ms ë’¤ì— í•¨ìˆ˜ ì‹¤í–‰
});

async function handleCardView() {
    // í•œ ì¹´ë“œì˜ ë„ˆë¹„ + ê°„ê²©ì„ 272pxë¡œ ê°€ì •
    const currentIndex = Math.round(cardSlider.scrollLeft / 272) + 1;

    // ì´ì „ì— ë³´ìƒë°›ì€ ì¸ë±ìŠ¤ë³´ë‹¤ ì»¤ì•¼ë§Œ API í˜¸ì¶œ
    if (currentIndex > appState.cardIndex && currentIndex <= 4) {
        try {
            const res = await apiPost('/api/cardview', { 
                userId: appState.userId, 
                cardIndex: currentIndex 
            });

            if (res.points_awarded > 0) {
                appState.totalPoints = res.total_points;
                appState.cardIndex = currentIndex;
                alert(`+${res.points_awarded} í¬ì¸íŠ¸!`);
                playSound('ding');
                showPointAnimation(res.points_awarded);
            }

            // ë§ˆì§€ë§‰ ì¹´ë“œ(4ë²ˆ)ì— ë„ë‹¬í–ˆì„ ë•Œ
            if (currentIndex === 4) {
                // ì‚¬íšŒì  ì¦ê±° ì—…ë°ì´íŠ¸ ë“±
                // ë‹¤ìŒ ë‹¨ê³„ ë…¸ì¶œ
                sectionCard.classList.add('hidden');
                sectionVideo.classList.remove('hidden');
                appState.stageState = 3;
            }
        } catch (error) {
            console.error('ì¹´ë“œë‰´ìŠ¤ ë³´ìƒ ì²˜ë¦¬ ì‹¤íŒ¨:', error);
        }
    }
}
[Backend] (main.py)
ì—”ë“œí¬ì¸íŠ¸: /api/cardviewë¥¼ êµ¬í˜„í•©ë‹ˆë‹¤.
ë¡œì§: ì¤‘ë³µ ë³´ìƒì„ ë°©ì§€í•˜ê¸° ìœ„í•´, ìš”ì²­ë°›ì€ cardIndexê°€ DBì— ì €ì¥ëœ ê°’ë³´ë‹¤ í° ê²½ìš°ì—ë§Œ í¬ì¸íŠ¸ë¥¼ ì§€ê¸‰í•©ë‹ˆë‹¤.
Python

class CardViewRequest(BaseModel):
    userId: str
    cardIndex: int

@app.post("/api/cardview")
async def cardview(req: CardViewRequest):
    nickname = req.userId
    user_card_idx_key = f"user:{nickname}:card_index"
    user_points_key = f"user:{nickname}:points"

    saved_idx = db.get(user_card_idx_key, 0)

    if req.cardIndex <= saved_idx:
        return {"points_awarded": 0, "total_points": db.get(user_points_key, 0)}

    points = 5 if req.cardIndex < 4 else 20

    db[user_card_idx_key] = req.cardIndex
    total_points = db.get(user_points_key, 0) + points
    db[user_points_key] = total_points

    if req.cardIndex == 4:
        db[f"user:{nickname}:stage_state"] = 3 # ì˜ìƒ ë‹¨ê³„ë¡œ ë³€ê²½

        # ì „ì—­ í†µê³„ ì—…ë°ì´íŠ¸
        stats = db.get("global_stats", {})
        stats["card_finishers"] = stats.get("card_finishers", 0) + 1
        db["global_stats"] = stats

    return {"points_awarded": points, "total_points": total_points}
6.5. 4ë‹¨ê³„: ì˜ìƒ ì‹œì²­
[Frontend] (app.js)
í•µì‹¬ ë¡œì§: timeupdate ì´ë²¤íŠ¸ëŠ” 1ì´ˆì— ì—¬ëŸ¬ ë²ˆ ë°œìƒí•˜ë¯€ë¡œ **ì“°ë¡œí‹€(Throttle)**ì„ ì ìš©í•˜ì—¬ 1ì´ˆì— í•œ ë²ˆë§Œ ì§„í–‰ë¥ ì„ ì²´í¬í•©ë‹ˆë‹¤.
UI ì—…ë°ì´íŠ¸: ì¤‘ê°„ ì§€ì ê³¼ ì™„ë£Œ ì§€ì ì—ì„œ ê°ê° ë³´ìƒ í”¼ë“œë°±ì„ ì£¼ê³ , ì™„ë£Œ ì‹œ ê²°ì œ ì±Œë¦°ì§€ ì„¹ì…˜ì„ ë…¸ì¶œí•©ë‹ˆë‹¤.
JavaScript

const promoVideo = document.getElementById('promo-video');
const sectionPay = document.getElementById('section-paychallenge');
let isThrottled = false;

promoVideo.addEventListener('timeupdate', () => {
    if (isThrottled) return;
    isThrottled = true;
    setTimeout(() => {
        handleVideoProgress();
        isThrottled = false;
    }, 1000); // 1ì´ˆì— í•œë²ˆë§Œ ì‹¤í–‰
});

async function handleVideoProgress() {
    const percent = (promoVideo.currentTime / promoVideo.duration) * 100;

    // ì¤‘ê°„(50%) ë³´ìƒ
    if (percent >= 50 && appState.videoProgress < 50) {
        appState.videoProgress = 50;
        const res = await apiPost('/api/video', { userId: appState.userId, progress: 50 });
        alert(`ì¤‘ê°„ ë³´ìƒ! +${res.points_awarded} í¬ì¸íŠ¸`);
        // ... (UI í”¼ë“œë°±)
    }

    // ì™„ë£Œ(100%) ë³´ìƒ (ended ì´ë²¤íŠ¸ë¥¼ ì“°ëŠ” ê²ƒì´ ë” ì •í™•)
    if (percent >= 99 && appState.videoProgress < 100) {
        appState.videoProgress = 100;
        const res = await apiPost('/api/video', { userId: appState.userId, progress: 100 });
        alert(`ì™„ë£Œ ë³´ìƒ! +${res.points_awarded} í¬ì¸íŠ¸`);

        // ë‹¤ìŒ ë‹¨ê³„ ë…¸ì¶œ
        sectionVideo.classList.add('hidden');
        sectionPay.classList.remove('hidden');
        appState.stageState = 4;
    }
}
[Backend] (main.py)
ì—”ë“œí¬ì¸íŠ¸: /api/videoë¥¼ êµ¬í˜„í•©ë‹ˆë‹¤.
ë¡œì§: ì¤‘ë³µ ë³´ìƒì„ ë°©ì§€í•˜ê¸° ìœ„í•´, ìš”ì²­ë°›ì€ progressê°€ DBì— ì €ì¥ëœ ê°’ë³´ë‹¤ ì»¤ì•¼ í¬ì¸íŠ¸ë¥¼ ì§€ê¸‰í•©ë‹ˆë‹¤.
Python

class VideoRequest(BaseModel):
    userId: str
    progress: int

@app.post("/api/video")
async def video(req: VideoRequest):
    nickname = req.userId
    progress = req.progress

    saved_progress = db.get(f"user:{nickname}:video_progress", 0)
    if progress <= saved_progress:
        return {"points_awarded": 0, "total_points": db.get(f"user:{nickname}:points", 0)}

    points = 10 if progress == 50 else 50

    db[f"user:{nickname}:video_progress"] = progress
    total_points = db.get(f"user:{nickname}:points", 0) + points
    db[f"user:{nickname}:points"] = total_points

    if progress == 100:
        db[f"user:{nickname}:stage_state"] = 4 # ê²°ì œ ë‹¨ê³„ë¡œ ë³€ê²½

        stats = db.get("global_stats", {})
        stats["video_viewers"] = stats.get("video_viewers", 0) + 1
        db["global_stats"] = stats

    return {"points_awarded": points, "total_points": total_points}
6.6. 5ë‹¨ê³„: ê²°ì œ ì±Œë¦°ì§€
[Frontend] (app.js)
í•µì‹¬ ë¡œì§: ê° ê²°ì œ ë²„íŠ¼ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ í• ë‹¹í•˜ì—¬, í´ë¦­ ì‹œ ê²°ì œ ê¸ˆì•¡ê³¼ í•¨ê»˜ /api/spendë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.
UI ì—…ë°ì´íŠ¸: API ì‘ë‹µì„ ë°”íƒ•ìœ¼ë¡œ ëˆ„ì  ê²°ì œì•¡, ì§„í–‰ë°”, íšë“í•œ ë³´ìƒ(í¬ì¸íŠ¸, ì¿ í°)ì„ í™”ë©´ì— ë°˜ì˜í•©ë‹ˆë‹¤.
JavaScript

// ê° ê²°ì œ ë²„íŠ¼ì— ëŒ€í•œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • (ì˜ˆì‹œ)
document.getElementById('btn-pay-50k').addEventListener('click', () => handlePayment(50000));
// ... ë‹¤ë¥¸ ë²„íŠ¼ë“¤ë„ ë™ì¼

async function handlePayment(amount) {
    try {
        // ì‹¤ì œ ê²°ì œì°½ ì—°ë™ ë¡œì§ì€ ì—¬ê¸°ì—... (ì§€ê¸ˆì€ ìƒëµ)

        const res = await apiPost('/api/spend', { userId: appState.userId, amount: amount });

        appState.spendAmount = res.total_spend;
        appState.totalPoints = res.total_points;

        alert(
            `${amount.toLocaleString()}ì› ê²°ì œ ì„±ê³µ!\n` +
            `+${res.points_awarded} í¬ì¸íŠ¸ íšë“!\n` +
            (res.coupon_awarded ? `ì¿ í° ${res.coupon_awarded} íšë“!` : '')
        );

        refreshSpendUI(); // ì§„í–‰ë°” ë“± UI ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    } catch (error) {
        alert('ê²°ì œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}

function refreshSpendUI() {
    // appState.spendAmountë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì§„í–‰ë°” ë„ˆë¹„, í…ìŠ¤íŠ¸ ë“±ì„ ì—…ë°ì´íŠ¸
    console.log('ê²°ì œ UI ì—…ë°ì´íŠ¸:', appState.spendAmount);
}
[Backend] (main.py)
ì—”ë“œí¬ì¸íŠ¸: /api/spendë¥¼ êµ¬í˜„í•©ë‹ˆë‹¤.
ë¡œì§: ê²°ì œ ê¸ˆì•¡ì„ ëˆ„ì í•˜ê³ , ì‚¬ì „ì— ì •ì˜ëœ **ë³´ìƒ êµ¬ê°„(Tiers)**ì„ ìˆœíšŒí•˜ë©° ì¡°ê±´ì— ë§ëŠ” ë³´ìƒì„ ì§€ê¸‰í•©ë‹ˆë‹¤. ì¤‘ë³µ ì§€ê¸‰ì„ ë§‰ê¸° ìœ„í•´ spend_tier ìƒíƒœë¥¼ ê¸°ë¡í•©ë‹ˆë‹¤.
Python

REWARD_TIERS = [
    {"threshold": 400000, "points": 1500, "coupon": "VIP_WEEK_FREE & DRAW3", "tier": 6},
    {"threshold": 300000, "points": 2000, "coupon": "UNLOCK_ADULT", "tier": 5},
    {"threshold": 200000, "points": 1500, "coupon": "MINIGAME_TICKETx2", "tier": 4},
    {"threshold": 150000, "points": 1000, "coupon": None, "tier": 3},
    {"threshold": 100000, "points": 500, "coupon": "VIP_COUPON", "tier": 2},
    {"threshold": 50000, "points": 200, "coupon": "DISCOUNT5%", "tier": 1}
]

class SpendRequest(BaseModel):
    userId: str
    amount: int

@app.post("/api/spend")
async def spend(req: SpendRequest):
    nickname = req.userId

    # ëˆ„ì  ê²°ì œì•¡ ì—…ë°ì´íŠ¸
    total_spend = db.get(f"user:{nickname}:spend_amount", 0) + req.amount
    db[f"user:{nickname}:spend_amount"] = total_spend

    current_tier = db.get(f"user:{nickname}:spend_tier", 0)
    points_to_add = 0
    coupon_to_add = None

    # ë³´ìƒ êµ¬ê°„ í™•ì¸
    for tier_info in REWARD_TIERS:
        if total_spend >= tier_info["threshold"] and current_tier < tier_info["tier"]:
            points_to_add = tier_info["points"]
            coupon_to_add = tier_info["coupon"]
            db[f"user:{nickname}:spend_tier"] = tier_info["tier"] # í‹°ì–´ ë‹¬ì„± ê¸°ë¡
            break # ê°€ì¥ ë†’ì€ ë‹¨ê³„ì˜ ë³´ìƒ í•˜ë‚˜ë§Œ ì§€ê¸‰

    # í¬ì¸íŠ¸ ì§€ê¸‰
    total_points = db.get(f"user:{nickname}:points", 0)
    if points_to_add > 0:
        total_points += points_to_add
        db[f"user:{nickname}:points"] = total_points

    return {
        "points_awarded": points_to_add,
        "coupon_awarded": coupon_to_add,
        "total_spend": total_spend,
        "total_points": total_points
    }